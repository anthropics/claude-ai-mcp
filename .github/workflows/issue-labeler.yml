name: Auto-label issues from templates

on:
  issues:
    types: [opened]

permissions:
  issues: write

jobs:
  label:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Apply template labels
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            const yaml = require('js-yaml');

            const issue = context.payload.issue;
            const templateDir = '.github/ISSUE_TEMPLATE';

            // Read all YAML issue templates
            const files = fs.readdirSync(templateDir).filter(f => f.endsWith('.yml') && f !== 'config.yml');

            for (const file of files) {
              const content = fs.readFileSync(path.join(templateDir, file), 'utf8');
              const template = yaml.load(content);

              // Match issue to template by checking if the issue body contains
              // the template's unique form fields (id values)
              if (!template.body) continue;

              const templateIds = template.body
                .filter(field => field.id)
                .map(field => field.id);

              // GitHub issue forms render field labels as ### headings in the body
              const templateLabels = template.body
                .filter(field => field.attributes && field.attributes.label)
                .map(field => field.attributes.label);

              const matchCount = templateLabels.filter(label =>
                issue.body && issue.body.includes(`### ${label}`)
              ).length;

              // Require a strong match: at least 3 heading matches and >50% of fields
              if (matchCount >= 3 && matchCount > templateLabels.length * 0.5) {
                const labels = template.labels || [];
                if (labels.length > 0) {
                  // Ensure all labels exist, create if missing
                  const existingLabels = await github.rest.issues.listLabelsForRepo({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    per_page: 100,
                  });
                  const existingNames = existingLabels.data.map(l => l.name);

                  for (const label of labels) {
                    if (!existingNames.includes(label)) {
                      await github.rest.issues.createLabel({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        name: label,
                      });
                    }
                  }

                  await github.rest.issues.addLabels({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issue.number,
                    labels: labels,
                  });
                  console.log(`Matched template "${template.name}", applied labels: ${labels.join(', ')}`);
                }
                break;
              }
            }
